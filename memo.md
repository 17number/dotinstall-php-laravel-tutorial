- [Composer](https://getcomposer.org) をインストール
  - `brew install homebrew/core/composer`
- Composer で Laravel をインストール
  - 公式: [Installation \- Laravel \- The PHP Framework For Web Artisans](https://laravel.com/docs/6.0/installation)
  - `composer create-project --prefer-dist laravel/laravel blog` でも OK
    - (たぶん)ダウンロード(?)とプロジェクトの作成まで実行
  - `composer global require laravel/installer` でグローバルインストール
    - `$HOME/.composer/vendor/bin` にダウンロードされるので PATH を通す
      - `echo export PATH="$HOME/.composer/vendor/bin:$PATH" >> ~/.bash_profile`
      - `source ~/.bash_profile`
    - プロジェクトの作成
      - `laravel new <app name>`
  - `php artisan --version` で Laravel のバージョン確認
- ディレクトリ構成
  - Model: `app`
  - Controller: `app/Http/Controllers`
  - Config: `conig`
  - DB: `database`
  - Assets: `public`
  - View: `resources/views`
  - Routing: `routes`
- コンフィグ設定
  - `config/` -> `.env` と参照することで、環境が変わっても `.env` だけ差し替えれば良い
    - `env(<KEY>, <DEFAULT VALUE>)` で `.env` から値の読み出し。未設定の場合は `<DEFAULT VALUE>` が使われる
  - `config/app.php`: アプリ全般に関する設定
- モデル作成
  - `php artisan make:model <Model> --migration` でモデルとマイグレーションファイルの作成
    - `php artisan make:model Post --migration`
- マイグレーションファイル
  - `up`: マイグレーション実行時の処理
  - `down`: ロールバック実行時の処理
  - `$table-><column type>(<column name>)` でカラムの作成
    - `$table->bigIngrements('id')`: `BIGINT`, Auto Increment の `id`
    - `$table->string('title')`: `VARCHAR` の `title`
    - `$table->text('body')`: `TEXT` の `body`
    - `$table->timestamps()`: `created_at`, `updated_at`
    - `$table->foreign('col')->references('id')->on('foreignTable')`: 外部キー制約
      - `->onDelete('cascade')`: 親レコードの削除時は子レコードも削除
- マイグレーション実行
  - `php artisan migrate`
- `php artisan tinker` でインタラクティブシェルの起動(モデルの操作ができる)
  - `new App\<ModelName>()` でインスタンス生成
    - デフォルトで namespace が `App` に設定されている
  - `$post->title = "hoge"` や `$post->save();` で値の設定や保存
  - `App\Post::all()` で全てのデータを取得
    - `App\Post::all()->toArray()` でレコードの内容のみを取得
- `App\<Model>::create([<key> => <value>, ...])` で作成と保存が可能
  - Mass Assignment の脆弱性対策がデフォルトで設定されている
    - `protected $fillable = ["key1", "key2", ...];` を `app/<Model>.php` に追加する
- データの取得
  - `App\<Model>::find(<id>)`: ID 指定
  - `App\<Model>::where("id", ">", 1)`: 条件指定
    - `->get()` でデータの取得
  - `orderBy("created_at", "desc")`: 並び替え
  - `take(<limit>)`: 件数の制限
  - `update(["key" => "value", ...])`: レコードの更新
    - 正常終了だと `true` が返る
  - `delete()`: レコードの削除
    - 正常終了だと `true` が返る
- ルーティング
  - `routes/web.php` で設定
  - `Route::get("/", "XxxxController@xxxx_method")` で URL と対応アクションを指定
    - パラメータを指定する場合は `Route::get("/{hoge}", ...)` とする
      - コントローラでは関数定義で仮引数を追加すれば OK
    - ルーティングは上から順に処理される
      - `->where("param", "[0-9]+")` とすることで、`param` を数値のみに限定できる
- コントローラ
  - `php artisan make:controller XxxxController` でコントローラの作成
    - `app/Http/Controllers/XxxxController.php`
  - `routes/web.php` に定義したアクションを作成する
  - ビューにデータを渡す
    - `view("posts.index", ["key" => "value"])` or
    - `view("posts.index")->with("key", "value")`
  - `findOrFail` でデータがない場合に例外を返す
    - `find` だとデータがない場合は `null` が返却される
    - `findOrFail` だと `Illuminate/Database/Eloquent/ModelNotFoundException with message 'No query results for model [App/Post] 1'` となる
- ビュー
  - `resources/views/<resouce>/<action>.blade.php` に作成(通例?)
  - コントローラでビューを使うには `return view("<dir>.<file>")` で指定
    - `resources/views/posts/index.blade.php` -> `view("posts.index")` となる
  - `{{-- --}}` でマルチラインコメント
  - `{{ }}` で変数の表示
  - `{{!! !!}}` でエスケープ無しの出力
    - [`e()`](https://laravel.com/docs/5.7/helpers#method-e): エスケープ
      - `e('<html>foo</html>')` -> `&lt;html&gt;foo&lt;/html&gt;`
    - [`nl2br()`](https://www.php.net/manual/ja/function.nl2br.php): 改行コードの前に `<br>` タグを追加
    - 上記をまとめて `{{!! nl2br(e($data)) !!}}` とすることで、改行つきで内容をそのまま出力となる
  - ループ処理
    - `@foreach` ~ `@endforeach`
    - `@forelse` ~ `@empty` ~ `@endforelse`
      - 中身が空だったときの処理を `@empty` 下に書ける
  - リンクの生成
    - `url("/posts", $post->id)` -> `/posts/{{ $posts->id }}` となる
    - `action("PostsController@show", $post-id)` でも同じ
  - `resources/views/layouts/xxxx.blade.php` で共通レイアウトを管理(このレッスンでは)
    - `layouts` の `@yield("key")` と `views` の `@section("key", "value")` とが紐づく
      - `@section("key", "value")` は `@section("key") ... @endsection` のようにも書ける
    - 共通レイアウトを利用する側(`views`)で `@extend("layouts.xxxx")` と書いて利用するレイアウトファイルを指定
- サーバの起動
  - `php artisan serve --host <ip addr> --port <port>` でサーバの起動
- `dd()`: dump and die
  - データをダンプして終了、データが取れているかの確認に使う　
- `Model::latest()`: `Model::orderBy("created_at", "desc")` と同じ
- Implicit Binding
  - Controller で引数を `Post $post` と定義することでよきに計らってくれる(っぽい)
    - デフォルトは `id` だが、モデルにメソッドを追加するとカスタマイズできる
      - [Laravelでwiki的なものをつくってみる\(後編\) \- Qiita](https://qiita.com/ohida/items/f5280ccbb10f9b43f92c#implicit-binding)
- フォームには CSRF 対策のため `{{ csrf_field() }}` を追加する必要がある
  - パラメータは `Request` 型でアクセスできる
    - フォームの各要素の `name` を使って `$request->title` のようにアクセス
  - フォームの HTTP method を変更したい場合は、フォーム内に `{{ method_field("patch") }}` のように `method_field` を使う
- `return redirect("path/to/resource")` でリダイレクト
- [バリデーション](https://readouble.com/laravel/5.8/ja/validation.html)
  - `$this->validate(<target>, [<rules>])` でバリデーション
    - `<rules>` は `"param" => "rule"` で記述
      - `required`: 必須
      - `min`: 最低文字数
      - `max`: 最大文字数
      - `unique:<model>`: ユニーク制約
      - etc...
  - バリデーションエラーは `$errors` でアクセス
    - `$errors->has("field")` で指定フィールドに関するエラー有無
    - `$errors->all()` で全てのエラー
    - `$errors->any()` でエラーがあるかどうか
  - ビューでエラーを表示する場合は `@if($errors->xxx) ... @endif`
  - バリデーションエラー時に、前の値を保持したい場合には `value="{{ old('field') }}` のように `old` を使う
    - 「編集開始時には元の値を表示」とする場合には `old('field', $post->field)` のように第二引数を利用する
- `php artisan make:request XxxxRequest` で `FormRequest` を継承した `XxxxRequest` を作成
  - 実体は `app/Http/Requests/XxxxRequest.php` に作成される
    - 編集後コントローラの該当アクションで引数として渡せば OK
  - バリデーションルールなどを共通化できる
    - `rules` を編集
  - バリデーションエラーのメッセージをカスタマイズする
    - `public function messages()` に定義
      - `return ["field.rule" => "custom message", ...]` でバリデーションごとのメッセージを定義可能
- モデル間の関連付け
  - `app/ParentModel.php` と `app/ChildModel.php` にメソッドを定義する
    - `public function children { return $this->hasMany("App\ChildModel"); }`
    - `public function parent { return $this->belongsTo("App\ParentModel"); }`
